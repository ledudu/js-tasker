/*! Build Date: 09:29:57 GMT+0800 (CST) Fri Jun 26 2015 File Name: js-tasker.js */
!function(e,s){"use strict";function t(e,s,t){var i;if(s){if([].indexOf)return[].indexOf.call(s,e,t);for(i=s.length,t=t?0>t?Math.max(0,i+t):t:0;i>t;t++)if(t in s&&s[t]===e)return t}return-1}function i(){}var d=!0;d=d&&window.console&&console.log;var n="20141027",h={depend:{},__check__:function(e){var s=["__check__","exec","kill","add"];if(-1!==t(e,s))throw Error("THIS METHOD DO NOT ALLOW REWRITE.");return!0},exec:function(e,i){if(!this.__check__(e))return!1;if(e in this)for(var n=0,o=this[e].length;o>n;n++)if(this.depend[e]&&this.depend[e].mask)for(var l in this.depend[e])this.depend[e].hasOwnProperty(l)&&-1!==t(n,this.depend[e][l].mask)&&this.depend[e][l].host!==s&&(d&&console.log("#任务正在执行：",i),h[e][this.depend[e][l].host]!==h[e][this.depend[e][l].mask]?(h[e][this.depend[e][l].host]&&h[e][this.depend[e][l].host].call(),h[e][this.depend[e][l].mask]&&h[e][this.depend[e][l].mask].call(),h.kill(e,this.depend[e][l].mask),h.kill(e,this.depend[e][l].host)):(h[e][this.depend[e][l].host]&&h[e][this.depend[e][l].host].call(),h.kill(e,this.depend[e][l].host)));else if(this.depend[e]&&!this.depend[e].mask)this.depend[e].host!==s&&(d&&console.log("#任务正在执行：",i),h[e][this.depend[e].host]&&h[e][this.depend[e].host].call(),h.kill(e,this.depend[e].host));else{if(this.depend[e])throw Error("WAITING FOR DEPEND FUNC REG.");d&&console.log("#任务正在执行[无依赖]：",i),this[e][n]&&this[e][n].call(),this.kill(e,n--),o--}},add:function(e){var s=e.cmd,n=e.func||i,o=e.trigger||!1,l=e.option,c=e.title||"";if(!s||!this.__check__(s))return!1;h[s]=h[s]||[],h[s].push(n),d&&console.log("#任务已添加：",c);var p=function(e){e in h&&h.exec(e,c)};if(l){var r=l.match(/(\w+):(\w+)/gi);if(r){var a=l.split(":"),f=a[0],k=a[1];switch(f){case"REG":d&&console.log("#更新依赖：",c),this.depend[k]=this.depend[k]||{},this.depend[k].host&&h[s][this.depend[k].host]&&this.kill(h[s],this.depend[k].host),this.depend[k].host=t(n,h[s]),o===!0&&p(s);break;case"DEP":d&&console.log("#调用依赖：",c),this.depend[k]?(h[s][this.depend[k]].call(null),delete this.depend[k],o===!0&&p(s)):(this.depend[k]={},this.depend[k].mask=this.depend[k].mask||[],this.depend[k].mask.push(t(n,h[s])))}}}else o===!0&&p(s)},kill:function(e,s){return this.__check__(e)?(h[e].splice(t(h[e][s],h[e]),1),h[e].length||delete h[e],void(d&&console.log("#删除了一个任务。"))):!1},version:n};e.task=h}(window);