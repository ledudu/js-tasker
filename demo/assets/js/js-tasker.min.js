/*! Build Date: 10:19:21 GMT+0800 (CST) Fri Jun 26 2015 File Name: js-tasker.js */
!function(e,t){"use strict";function n(e,t,n){var s;if(t){if([].indexOf)return[].indexOf.call(t,e,n);for(s=t.length,n=n?0>n?Math.max(0,s+n):n:0;s>n;n++)if(n in t&&t[n]===e)return n}return-1}function s(){}var i=!0;i=i&&window.console&&console.log;var d="20150626",h=[],o={depend:{},__check__:function(e){var t=["__check__","exec","kill","add"];if(-1!==n(e,t))throw Error("THIS METHOD DO NOT ALLOW REWRITE.");return!0},exec:function(e,s){if(!this.__check__(e))return!1;if(e in this)for(var d=0,h=this[e].length;h>d;d++)if(this.depend[e]&&this.depend[e].mask)for(var l in this.depend[e])this.depend[e].hasOwnProperty(l)&&-1!==n(d,this.depend[e][l].mask)&&this.depend[e][l].host!==t&&(i&&console.log("#任务正在执行：",s),o[e][this.depend[e][l].host]!==o[e][this.depend[e][l].mask]?(o[e][this.depend[e][l].host]&&o[e][this.depend[e][l].host].call(),o[e][this.depend[e][l].mask]&&o[e][this.depend[e][l].mask].call(),o.kill(e,this.depend[e][l].mask),o.kill(e,this.depend[e][l].host)):(o[e][this.depend[e][l].host]&&o[e][this.depend[e][l].host].call(),o.kill(e,this.depend[e][l].host)));else if(this.depend[e]&&!this.depend[e].mask)this.depend[e].host!==t&&(i&&console.log("#任务正在执行：",s),o[e][this.depend[e].host]&&o[e][this.depend[e].host].call(),o.kill(e,this.depend[e].host));else{if(this.depend[e])throw Error("WAITING FOR DEPEND FUNC REG.");i&&console.log("#任务正在执行[无依赖]：",s),this[e][d]&&this[e][d].call(),this.kill(e,d--),h--}},add:function(e){var t=e.cmd,d=e.func||s,h=e.trigger||!1,l=e.option,c=e.title||"";if(!t||!this.__check__(t))return!1;o[t]=o[t]||[],o[t].push(d),i&&console.log("#任务已添加：",c);var p=function(e){e in o&&o.exec(e,c)};if(l){var r=l.match(/(\w+):(\w+)/gi);if(r){var a=l.split(":"),u=a[0],f=a[1];switch(u){case"REG":i&&console.log("#更新依赖：",c),this.depend[f]=this.depend[f]||{},this.depend[f].host&&o[t][this.depend[f].host]&&this.kill(o[t],this.depend[f].host),this.depend[f].host=n(d,o[t]),h===!0&&p(t);break;case"DEP":i&&console.log("#调用依赖：",c),this.depend[f]?(o[t][this.depend[f]].call(null),delete this.depend[f],h===!0&&p(t)):(this.depend[f]={},this.depend[f].mask=this.depend[f].mask||[],this.depend[f].mask.push(n(d,o[t])))}}}else h===!0&&p(t)},kill:function(e,t){return this.__check__(e)?(o[e].splice(n(o[e][t],o[e]),1),o[e].length||delete o[e],void(i&&console.log("#删除了一个任务。"))):!1},delay:function(e,t){return e&&(t&&isNaN(t)||(t=1e3),h.push([function(){e(),o.next()},t])),o},next:function(){return h.length&&e.setTimeout.apply(null,h.shift()),o},start:function(){return h.length&&e.setTimeout.apply(null,h.shift()),o},_checkQueue:function(){},version:d};e.task=o}(window);