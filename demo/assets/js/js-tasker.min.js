/*! Build Date: 11:12:33 GMT+0800 (CST) Fri Jun 26 2015 File Name: js-tasker.js */
!function(t,o,e){"use strict";function l(t,o,e){var l;if(o){if([].indexOf)return[].indexOf.call(o,t,e);for(l=o.length,e=e?0>e?Math.max(0,l+e):e:0;l>e;e++)if(e in o&&o[e]===t)return e}return-1}function n(){}o=o&&window.console&&console.log;var s="20150626",i=[],c={},r={__check__:function(t){var o=["__check__","exec","kill","add"];if(-1!==l(t,o))throw Error("THIS METHOD DO NOT ALLOW REWRITE.");return!0},exec:function(t,n){if(!this.__check__(t))return!1;if(t in this)for(var s=0,i=this[t].length;i>s;s++)if(c[t]&&c[t].mask)for(var h in c[t])c[t].hasOwnProperty(h)&&-1!==l(s,c[t][h].mask)&&c[t][h].host!==e&&(o&&console.log("#任务正在执行：",n),r[t][c[t][h].host]!==r[t][c[t][h].mask]?(r[t][c[t][h].host]&&r[t][c[t][h].host].call(),r[t][c[t][h].mask]&&r[t][c[t][h].mask].call(),r.kill(t,c[t][h].mask),r.kill(t,c[t][h].host)):(r[t][c[t][h].host]&&r[t][c[t][h].host].call(),r.kill(t,c[t][h].host)));else if(c[t]&&!c[t].mask)c[t].host!==e&&(o&&console.log("#任务正在执行：",n),r[t][c[t].host]&&r[t][c[t].host].call(),r.kill(t,c[t].host));else{if(c[t])throw Error("WAITING FOR DEPEND FUNC REG.");o&&console.log("#任务正在执行[无依赖]：",n),this[t][s]&&this[t][s].call(),this.kill(t,s--),i--}},add:function(t){var e=t.cmd,s=t.func||n,i=t.trigger||!1,h=t.option,a=t.title||"";if(!e||!this.__check__(e))return!1;r[e]=r[e]||[],r[e].push(s),o&&console.log("#任务已添加：",a);var u=function(t){t in r&&r.exec(t,a)};if(h){var f=h.match(/(\w+):(\w+)/gi);if(f){var k=h.split(":"),_=k[0],g=k[1];switch(_){case"REG":o&&console.log("#更新依赖：",a),c[g]=c[g]||{},c[g].host&&r[e][c[g].host]&&this.kill(r[e],c[g].host),c[g].host=l(s,r[e]),i===!0&&u(e);break;case"DEP":o&&console.log("#调用依赖：",a),c[g]?(r[e][c[g]].call(null),delete c[g],i===!0&&u(e)):(c[g]={},c[g].mask=c[g].mask||[],c[g].mask.push(l(s,r[e])))}}}else i===!0&&u(e)},kill:function(t,e){return this.__check__(t)?(r[t].splice(l(r[t][e],r[t]),1),r[t].length||delete r[t],void(o&&console.log("#删除了一个任务。"))):!1},delay:function(t,o){return t&&((!o||isNaN(o))&&(o=1e3),i.push([function(){t(),r.next()},o])),r},next:function(){return i.length&&t.setTimeout.apply(null,i.shift()),r},start:function(){return i.length&&t.setTimeout.apply(null,i.shift()),r},_checkQueue:function(){},version:s};t.task=r}(window,!1);