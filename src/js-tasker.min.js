/**
 * Project: js-tasker
 * Author: soulteary
 * Date: 2014/10/27 19:58
 */
(function(m,l){function k(a,b,c){var f;if(b){if([].indexOf)return[].indexOf.call(b,a,c);f=b.length;for(c=c?0>c?Math.max(0,f+c):c:0;c<f;c++)if(c in b&&b[c]===a)return c}return-1}var g=!0,g=g&&window.console&&console.log;m.task={depend:{},__check__:function(a){if(-1!==k(a,["__check__","exec","kill","add"]))throw Error("THIS METHOD DO NOT ALLOW REWRITE.");return!0},exec:function(a,b){if(!this.__check__(a))return!1;if(a in this)for(var c=0,f=this[a].length;c<f;c++)if(this.depend[a]&&this.depend[a].mask)$(this.depend[a]).each(function(f,d){-1!==k(c,d.mask)&&d.host!==l&&(g&&console.log("#\u4efb\u52a1\u6b63\u5728\u6267\u884c\uff1a",b),task[a][d.host]!==task[a][d.mask]?(task[a][d.host]&&task[a][d.host].call(),task[a][d.mask]&&task[a][d.mask].call(),task.kill(a,d.mask)):task[a][d.host]&&task[a][d.host].call(),task.kill(a,d.host))});else if(this.depend[a]&&!this.depend[a].mask)this.depend[a].host,this.depend[a].host!==l&&(g&&console.log("#\u4efb\u52a1\u6b63\u5728\u6267\u884c\uff1a",b),task[a][this.depend[a].host]&&task[a][this.depend[a].host].call(),task.kill(a,this.depend[a].host));else{if(this.depend[a])throw Error("WAITING FOR DEPEND FUNC REG.");g&&console.log("#\u4efb\u52a1\u6b63\u5728\u6267\u884c[\u65e0\u4f9d\u8d56]\uff1a",b);this[a][c]&&this[a][c].call();this.kill(a,c--);f--}},add:function(a){var b=a.cmd,c=a.func||function(){},f=a.trigger||!1,h=a.option,d=a.title||"";if(!b||!this.__check__(b))return!1;task[b]=task[b]||[];task[b].push(c);g&&console.log("#\u4efb\u52a1\u5df2\u6dfb\u52a0\uff1a",d);a=function(a){a in task&&task.exec(a,d)};if(h){if(h.match(/(\w+):(\w+)/ig)){var h=h.split(":"),e=h[1];switch(h[0]){case "REG":g&&console.log("#\u66f4\u65b0\u4f9d\u8d56\uff1a",d);this.depend[e]=this.depend[e]||{};this.depend[e].host&&task[b][this.depend[e].host]&&this.kill(task[b],this.depend[e].host);this.depend[e].host=k(c,task[b]);!0===f&&a(b);break;case "DEP":g&&console.log("#\u8c03\u7528\u4f9d\u8d56\uff1a",d),this.depend[e]?(task[b][this.depend[e]].call(null),delete this.depend[e],!0===f&&a(b)):(this.depend[e]={},this.depend[e].mask=this.depend[e].mask||[],this.depend[e].mask.push(k(c,task[b])))}}}else!0===f&&a(b)},kill:function(a,b){if(!this.__check__(a))return!1;task[a].splice(k(task[a][b],task[a]),1);task[a].length||delete task[a];g&&console.log("#\u5220\u9664\u4e86\u4e00\u4e2a\u4efb\u52a1\u3002")},version:"20141027"}})(window);